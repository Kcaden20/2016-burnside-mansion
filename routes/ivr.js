var express = require('express');var router = express.Router();var twilio = require('twilio');// POST: '/ivr/welcome'router.post('/welcome', twilio.webhook({validate: false}), function (request, response) {    var twiml = new twilio.TwimlResponse();    twiml.gather({        action: "/ivr/menu",        numDigits: "1",        method: "POST"    }, function (node) {         node.pause({ length: 2});        node.say("It's been a late night in studio. You've been up all night doing work for Newly Formed. This night is foggy and it's hard to see anything. You manage to make out the Bernside Mansion but you wish you didn't as you hear yelling and screaming from the inside. Press 1 to go into the house or press 2 to keep walking home ");        node.pause({length: 1});        node.play('http://kevincadena.com/seq/phone.wav', {loop:100});    });    response.send(twiml);});// POST: '/ivr/menu'router.post('/menu', twilio.webhook({validate: false}), function (request, response) {    var selectedOption = request.body.Digits;    var optionActions = {        "1": goIn,        "2": walkHome,        };    if (optionActions[selectedOption]) {        var twiml = new twilio.TwimlResponse();        optionActions[selectedOption](twiml);        response.send(twiml);    }    response.send(redirectWelcome());});// POST: '/ivr/planets'router.post('/going', twilio.webhook({validate: false}), function (request, response) {    var selectedOption = request.body.Digits;    var optionActions = {        "1": theStairs,        "2": theBase,        "3": theDoor,        "4": walkHome    };    if (optionActions[selectedOption]) {        var twiml = new twilio.TwimlResponse();        optionActions[selectedOption](twiml);        response.send(twiml);    } else {	    response.send(redirectWelcome());	    }});router.post('/door', twilio.webhook({validate: false}), function (request, response) {    var selectedOption = request.body.Digits;    var optionActions = {        "1": tugAgain,        "2": goBack,    };    if (optionActions[selectedOption]) {        var twiml = new twilio.TwimlResponse();        optionActions[selectedOption](twiml);        response.send(twiml);    } else {	    response.send(redirectWelcome());	    }});router.post('/stair', twilio.webhook({validate: false}), function (request, response) {    var selectedOption = request.body.Digits;    var optionActions = {        "1": goUp,        "2": goBack,    };    if (optionActions[selectedOption]) {        var twiml = new twilio.TwimlResponse();        optionActions[selectedOption](twiml);        response.send(twiml);    } else {	    response.send(redirectWelcome());	    }});router.post('/base', twilio.webhook({validate: false}), function (request, response) {    var selectedOption = request.body.Digits;    var optionActions = {        "1": goBack    };    if (optionActions[selectedOption]) {        var twiml = new twilio.TwimlResponse();        optionActions[selectedOption](twiml);        response.send(twiml);    } else {	    response.send(redirectWelcome());	    }}); var walkHome = function (twiml) {	twiml.pause({length:3});    twiml.say("You continue on your way home. When you get back, you eat some pita chips with hummus. It's pretty delicious. You call it a night and go to sleep.", {voice: "alice", language: "en-GB"});    twiml.pause({length:3});    twiml.hangup();    return twiml;};var goIn = function (twiml) {    twiml.gather({        action: "/ivr/going",        numDigits: "1",        method: "POST"    }, function (node) {        node.say("You walk up the stairs and the door is left open. You open it more and go in. " +            "Where did that scream come from? As you look around, there's a staircase that can lead upstairs or to the basement. There's also a door on the right. Press 1 to go up the stairs, Press 2 to check the basement, press 3 to check the door or press 4 to leave ",            {voice: "alice", language: "en-GB"});    });    return twiml;};var theStairs = function (twiml) {    twiml.gather({        action: "/ivr/stair",        numDigits: "1",        method: "POST"    }, function (node) {        node.say("You walk up the stairs. It's dark and cold and a hollow howl fills the stairway. Your hair stands on its ends as your heart rate jumps. Press 1 to keep walking up the stairs. Press 2 to go back down.",            {voice: "alice", language: "en-GB"});    });    return twiml;};var goUp = function (twiml) {    twiml.gather({        action: "/ivr/base",        numDigits: "1",        method: "POST"    }, function (node) {        node.say("As you reach the second floor, a flickering light illumnates it. There's only a dead silence and the doors are locked. Your heart rate starts to stabilize again. Might as well head back. Press 1 to go back down.");    });    return twiml;};var theBase = function (twiml) {    twiml.gather({        action: "/ivr/base",        numDigits: "1",        method: "POST"    }, function (node) {        node.say("The basement is empty, though you feel your body tense up as you inspect one of the corners. There's dried blood stains on the wall. This is a dead end, otherwise. Press 1 to go back up to the main hall. ");    });    return twiml;};var theDoor = function (twiml) {    twiml.gather({        action: "/ivr/door",        numDigits: "1",        method: "POST"    }, function (node) {        node.say("You come up to the door and pull once, it budges. Press 1 to tug again, Press 2 to go back ",            {voice: "alice", language: "en-GB"});    });    return twiml;};var tugAgain = function (twiml) {	twiml.pause({length:1});    twiml.say("The door gives and something falls on top of you. You feel it's grip against you as you feel your heart sink");    twiml.pause({length:3});    twiml.play("http://kevincadena.com/seq/dead.wav");    twiml.hangup();    return twiml;};var goBack = function (twiml) {	  twiml.gather({        action: "/ivr/going",        numDigits: "1",        method: "POST"    }, function (node) {        node.say("Where to now? Press 1 to go up the stairs, press 2 to go to the basement, press 3 to go to the door or press 4 to leave ",            {voice: "alice", language: "en-GB"});    });    return twiml;};var redirectWelcome = function () {    var twiml = new twilio.TwimlResponse();    twiml.say("", {voice: "alice", language: "en-GB"});    twiml.redirect("/ivr/going");    return twiml;};module.exports = router;